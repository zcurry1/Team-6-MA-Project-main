<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Customer Checkout</title>
  <link rel="stylesheet" href="universal-styles.css">
  <style>
    .preview {
      margin-top: 6px;
    }
    .preview-container {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 4px;
    }
    .brand-badge {
      display: inline-flex;
      align-items: center;
      height: 28px;
      padding: 6px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,0.03);
      font-size: 13px;
      color: inherit;
      align-self: flex-start;
    }
    #maskedPreview {
      color: var(--text-muted, #94a3b8);
      font-size: 13px;
      display: block;
    }
    .card-logo {
      height: 28px;
      width: auto;
      object-fit: contain;
      border-radius: 4px;
    }
    .preview {
      display: flex;
      align-items: center;
      margin-top: 6px;
      font-size: 13px;
      color: var(--text-muted, #94a3b8);
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div style="display: flex; align-items: center; gap: 15px; justify-content: center; margin-bottom: 20px;">
      <img src="KSUS Logo.png" alt="KSUS Logo" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover;">
      <h1 class="ksus-logo" style="margin: 0;">KSUS Store</h1>
    </div>


    <div class="grid">
      <div>
        <form id="checkoutForm" class="panel" autocomplete="off">
          <h3>Shipping Details</h3>
          <div class="row">
            <div>
              <label for="firstName">First name</label>
              <input id="firstName" type="text" required />
            </div>
            <div>
              <label for="lastName">Last name</label>
              <input id="lastName" type="text" required />
            </div>
          </div>

          <label for="address1">Address</label>
          <input id="address1" type="text" placeholder="123 Main St" required />

          <div class="row margin-top-8">
            <div>
              <label for="city">City</label>
              <input id="city" type="text" required />
            </div>
            <div>
              <label for="state">State</label>
              <select id="state" required></select>
            </div>
          </div>

          <div class="row margin-top-8">
            <div>
              <label for="zip">ZIP</label>
              <input id="zip" type="text" inputmode="numeric" required />
            </div>
            <div>
              <label for="email">Email</label>
              <input id="email" type="email" required />
            </div>
          </div>

          <h3 class="margin-top-16">Delivery</h3>
          <div id="shippingOptions"></div>

          <h3 class="margin-top-16">Payment</h3>
          <label for="cardNumber">Card number</label>
          <input id="cardNumber" type="text" inputmode="numeric" placeholder="4242 4242 4242 4242" autocomplete="cc-number" required />
          <div class="preview">
            <div class="preview-container">
              <span id="brandBadge" class="brand-badge"></span>
              <div id="maskedPreview"></div>
            </div>
          </div>

          <label class="muted margin-top-8">
            <input id="maskToggle" type="checkbox" /> Mask as I type
          </label>

          <div class="row margin-top-8">
            <input id="exp" placeholder="MM/YY" />
            <input id="cvc" class="small" placeholder="CVC" inputmode="numeric" />
          </div>

          <label class="muted margin-top-12">
            <input id="agree" type="checkbox" /> I agree to the Terms of Service & Refund Policy
          </label>

          <div class="controls">
            <button id="placeBtn" class="btn" type="submit">Pay <span id="totalBtn">$0.00</span></button>
          </div>

          <div id="loading">Processing order…</div>
          <div id="result" class="result"></div>
          <div id="status" class="status"></div>
        </form>
      </div>

      <aside>
        <div class="panel">
          <h3>Order Summary</h3>
      
          <div class="totals">
            <div class="line"><div>Subtotal</div><div id="subtotal">$0.00</div></div>
            <div class="line"><div>Taxes (7%)</div><div id="taxes">$0.00</div></div>
            <div class="line"><div>Shipping</div><div id="shippingCost">$0.00</div></div>
            <div class="divider-line"></div>
            <div class="line font-weight-600"><div>Total</div><div id="total">$0.00</div></div>
          </div>
        </div>

        <div class="height-spacer"></div>
      </aside>
    </div>

    <footer>Demo only — do not use this for PCI-sensitive flows in production. Use tokenization (Stripe/Stripe Elements/etc.).</footer>
  </div>

  <script>
    // Generate random order amounts
    function generateRandomOrderAmount() {
      const min = 25.00;
      const max = 300.00;
      return round2(Math.random() * (max - min) + min);
    }

    function generateRandomShipping() {
      const shippingOptions = [5.00, 14.00, 29.00];
      return shippingOptions[Math.floor(Math.random() * shippingOptions.length)];
    }

    const SHIPPING = [
      { id: "standard", label: "Standard (5–7 days)", cost: 5.0 },
      { id: "express", label: "Express (2–3 days)", cost: 14.0 },
      { id: "overnight", label: "Overnight (1 day)", cost: 29.0 },
    ];

    const STATES = ["AL","AK","AZ","AR","CA","CO","CT","DC","DE","FL","GA","HI","IA","ID","IL","IN","KS","KY","LA","MA","MD","ME","MI","MN","MO","MS","MT","NC","ND","NE","NH","NJ","NM","NV","NY","OH","OK","OR","PA","RI","SC","SD","TN","TX","UT","VA","VT","WA","WI","WV"];

    // Utils
    function fmt(n){ return new Intl.NumberFormat(undefined,{style:'currency',currency:'USD'}).format(Number(n||0)); }
    function round2(n){ return Math.round((n+Number.EPSILON)*100)/100; }

    function guessBrand(num){
      const n = (num||"").replace(/\D/g,"");
      if (/^4\d{12,18}$/.test(n)) return "Visa";
      if (/^5[1-5]\d{14}$/.test(n)) return "Mastercard";
      if (/^3[47]\d{13}$/.test(n)) return "AmEx";
      if (/^6(?:011|5)\d{12,15}$/.test(n)) return "Discover";
      return "Card";
    }

    function maskCardNumber(cardNumber){
      const n = (cardNumber||"").replace(/\D/g,"");
      if (n.length <= 4) return n;
      const masked = n.slice(0,-4).replace(/./g,"•");
      return formatCardNumber(masked + n.slice(-4));
    }

    function formatCardNumber(digitsRaw){
      const n = (digitsRaw||"").replace(/\D/g,"");
      const brand = guessBrand(n);
      if (brand === "AmEx") {
        // 4-6-5 grouping
        return (n.slice(0,4) + (n.length>4 ? " " + n.slice(4,10):"") + (n.length>10 ? " " + n.slice(10,15) : "")).trim();
      }
      // default groups of 4
      return n.replace(/(.{4})/g,"$1 ").trim();
    }

    // Format a string that may contain dots (•) and digits into spaced groups
    function formatMaskedString(s){
      // remove existing spaces
      const raw = (s||"").replace(/\s+/g,"");
      // decide grouping by brand using digits-only
      const onlyDigits = raw.replace(/•/g,'').replace(/\D/g,'');
      const brand = guessBrand(onlyDigits);
      const groups = brand === 'AmEx' ? [4,6,5] : [4,4,4,4,3];
      const parts = [];
      let idx = 0;
      for (let g of groups){
        if (idx >= raw.length) break;
        parts.push(raw.slice(idx, idx+g));
        idx += g;
      }
      if (idx < raw.length) parts.push(raw.slice(idx));
      return parts.join(' ').trim();
    }

    // Safe POST (no offline queue)
    async function safePost(url, payload){
      try {
        const res = await fetch(url, {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error("Bad status");
        return { ok:true, status: res.status, body: await res.json().catch(()=>null) };
      } catch (err) {
        // Offline queue removed: do not persist locally. Return error for caller to handle.
        return { ok:false, error: err.message };
      }
    }

    // App state
    const state = {
      subtotal: 0,
      shippingId: "standard",
      taxRate: 0.07,
      shippingMethods: SHIPPING,
      ship: { firstName:"", lastName:"", address1:"", city:"", state:"GA", zip:"", email:"", phone:"" },
      card: { number:"", nameOnCard:"", exp:"", cvc:"" },
      placing:false,
      status:null
    };

    // DOM refs
    const shippingOptionsEl = document.getElementById("shippingOptions");
    const stateSelect = document.getElementById("state");
    const subtotalEl = document.getElementById("subtotal");
    const taxesEl = document.getElementById("taxes");
    const shippingCostEl = document.getElementById("shippingCost");
    const totalEl = document.getElementById("total");
    const totalBtnEl = document.getElementById("totalBtn");
    const cardNumberInput = document.getElementById("cardNumber");
    const maskedPreviewEl = document.getElementById("maskedPreview");
    const brandBadgeEl = document.getElementById("brandBadge");
    const placeBtn = document.getElementById("placeBtn");
    const statusEl = document.getElementById("status");

    // Initialize selects and shipping radios
    (function init(){
      // Add blank "Select State" option first
      const blankOpt = document.createElement("option"); 
      blankOpt.value = ""; 
      blankOpt.textContent = "Select State";
      blankOpt.disabled = true;
      blankOpt.selected = true;
      stateSelect.appendChild(blankOpt);
      
      // Add all state options
      STATES.forEach(s => {
        const opt = document.createElement("option"); opt.value = s; opt.textContent = s;
        stateSelect.appendChild(opt);
      });

      SHIPPING.forEach((m) => {
        const id = "ship-" + m.id;
        const wrap = document.createElement("label");
        wrap.style.display = "flex"; wrap.style.justifyContent = "space-between"; wrap.style.padding = "8px"; wrap.style.borderRadius = "8px";
        wrap.style.cursor = "pointer"; wrap.style.marginBottom = "6px"; wrap.style.border = "1px solid rgba(255,255,255,0.03)";
        const left = document.createElement("div"); left.style.display="flex"; left.style.alignItems="center"; left.style.gap="8px"; left.style.width="180px";
        const radio = document.createElement("input"); radio.type="radio"; radio.name="shipping"; radio.value=m.id; radio.style.marginRight="6px";
        if (m.id === state.shippingId) radio.checked = true;
        radio.addEventListener("change", ()=>{ state.shippingId = m.id; renderTotals(); });
        left.appendChild(radio);
        left.appendChild(document.createTextNode(m.label));
        const cost = document.createElement("div"); cost.textContent = fmt(m.cost); cost.style.textAlign = "right"; cost.style.minWidth = "60px";
        wrap.appendChild(left); wrap.appendChild(cost);
        shippingOptionsEl.appendChild(wrap);
      });

      // Generate initial random pricing
      state.subtotal = generateRandomOrderAmount();
      renderTotals();
      attachEvents();
    })();

    function currentShippingCost(){ const m = SHIPPING.find(x=>x.id===state.shippingId); return m ? m.cost : 0; }
    
    function renderTotals(){
      const subtotal = state.subtotal;
      const taxes = round2(subtotal * state.taxRate);
      const shippingCost = currentShippingCost();
      const total = round2(subtotal + taxes + shippingCost);
      subtotalEl.textContent = fmt(subtotal);
      taxesEl.textContent = fmt(taxes);
      shippingCostEl.textContent = fmt(shippingCost);
      totalEl.textContent = fmt(total);
      totalBtnEl.textContent = fmt(total);
    }

    // Events & validation
    function attachEvents(){
      // format card input on each input, store digits-only
      const maskToggle = document.getElementById('maskToggle');

      function renderCardInput(){
        const digits = state.card.number || '';
        if (!maskToggle.checked){
          cardNumberInput.value = formatCardNumber(digits);
        } else {
          if (!digits) cardNumberInput.value = '';
          else if (digits.length <= 4) cardNumberInput.value = digits;
          else {
            const masked = '•'.repeat(Math.max(0, digits.length - 4)) + digits.slice(-4);
            cardNumberInput.value = formatMaskedString(masked);
          }
        }
      }

      cardNumberInput.addEventListener("input", (e)=>{
        // Only handle input events when mask is OFF. When mask is ON we manage digits via keydown/paste
        if (maskToggle.checked) return;
        // extract digits the user typed (ignore any non-digit characters)
        const digits = (e.target.value || "").replace(/\D/g,"").slice(0,19);
        state.card.number = digits;
    // re-render according to toggle (will render formatted since mask is off)
    renderCardInput();
    // update preview and brand
    updateCardPreview();
        try { e.target.setSelectionRange(e.target.value.length, e.target.value.length); } catch (err) {}
      });

      // When mask toggle is ON we intercept key presses and paste to preserve underlying digits
      cardNumberInput.addEventListener('keydown', (e)=>{
        if (!maskToggle.checked) return; // only active in mask mode
        const key = e.key;
        // allow navigation keys
        if (key === 'Tab' || key === 'ArrowLeft' || key === 'ArrowRight' || key === 'Home' || key === 'End') return;
        if (/^\d$/.test(key)){
          // append digit if under limit
          if ((state.card.number||'').length < 19){
            state.card.number = (state.card.number || '') + key;
            renderCardInput();
            updateCardPreview();
          }
          e.preventDefault();
          return;
        }
        if (key === 'Backspace'){
          // remove last digit
          state.card.number = (state.card.number || '').slice(0, -1);
          renderCardInput();
          updateCardPreview();
          e.preventDefault();
          return;
        }
        // prevent other characters
        e.preventDefault();
      });

      cardNumberInput.addEventListener('paste', (e)=>{
        if (!maskToggle.checked) return; // normal paste allowed when mask off
        const text = (e.clipboardData || window.clipboardData).getData('text') || '';
        const digits = text.replace(/\D/g,'').slice(0, 19 - (state.card.number||'').length);
        if (digits.length){
          state.card.number = (state.card.number || '') + digits;
          renderCardInput();
          updateCardPreview();
        }
        e.preventDefault();
      });

      maskToggle.addEventListener('change', ()=>{ renderCardInput(); try { cardNumberInput.focus(); cardNumberInput.setSelectionRange(cardNumberInput.value.length, cardNumberInput.value.length); } catch(e){} });

      document.getElementById("exp").addEventListener("input", (e)=>{
        // auto format MM/YY
        let v = e.target.value.replace(/\D/g,"").slice(0,4);
        if (v.length >= 3) v = v.slice(0,2) + '/' + v.slice(2);
        e.target.value = v;
      });

      document.getElementById("zip").addEventListener("input",(e)=>{ e.target.value = e.target.value.replace(/[^\d\-]/g,"").slice(0,10); });
document.getElementById("cvc").addEventListener("input",(e)=>{ 
  e.target.value = e.target.value.replace(/[^\d]/g,"").slice(0,4); 
});
      document.getElementById("checkoutForm").addEventListener("submit", placeOrder);
    }

    function updateCardPreview(){
      maskedPreviewEl.textContent = state.card.number ? "Card: " + maskCardNumber(state.card.number) : "";
      const brand = state.card.number ? guessBrand(state.card.number) : null;

      if (brand === 'Card') {
        // Show text badge for unrecognized cards
        brandBadgeEl.style.display = "inline-flex";
        brandBadgeEl.innerHTML = "";
        brandBadgeEl.textContent = brand;
      } else if (brand) {
        // Show logo for recognized card brands
        brandBadgeEl.style.display = "inline-flex";
        brandBadgeEl.innerHTML = "";
        const img = document.createElement('img');
        img.alt = brand + ' logo';
        img.className = 'card-logo';

        switch (brand) {
          case 'Visa':
            img.src = 'Card Logos/visa.png';
            break;
          case 'Mastercard':
            img.src = 'Card Logos/mastercard.png';
            break;
          case 'AmEx':
            img.src = 'Card Logos/amex.png';
            break;
          case 'Discover':
            img.src = 'Card Logos/discover.png';
            break;
        }
        brandBadgeEl.appendChild(img);
      }
    }

    // Save order data to database (silent background operation)
    async function saveOrderToDatabase(orderData) {
        try {
            const response = await fetch('/api/save-order', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(orderData)
            });
            
            const result = await response.json();
            if (result.success) {
                console.log('Order saved to database:', result.orderId);
            } else {
                console.error('Failed to save to database:', result.error);
            }
        } catch (error) {
            console.error('Database save error:', error);
        }
    }

    function validateForm(){
      const ship = {
        firstName: document.getElementById("firstName").value.trim(),
        lastName: document.getElementById("lastName").value.trim(),
        address1: document.getElementById("address1").value.trim(),
        city: document.getElementById("city").value.trim(),
        state: document.getElementById("state").value,
        zip: document.getElementById("zip").value.trim(),
        email: document.getElementById("email").value.trim()
      };
      if (!ship.firstName || !ship.lastName) return "Enter your name.";
      if (!ship.address1 || !ship.city || !ship.state || !ship.zip) return "Enter full shipping address.";
      if (!/^[0-9]{5}(?:-[0-9]{4})?$/.test(ship.zip)) return "Enter a valid ZIP code.";
      if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(ship.email)) return "Enter a valid email.";
      const digits = state.card.number || "";
      if (!/^\d{13,19}$/.test(digits)) return "Enter a valid card number.";
      if (!/^\d{2}\/\d{2}$/.test(document.getElementById("exp").value)) return "Expiry must be MM/YY.";
      const [expMonth, expYear] = document.getElementById("exp").value.split("/").map(s=>parseInt(s,10));
      const now = new Date();
      if (expMonth < 1 || expMonth > 12) return "Enter a valid expiration month.";
      const currentYear = now.getFullYear() % 100; // two-digit year
      if (expYear < currentYear || (expYear === currentYear && expMonth < (now.getMonth()+1))) return "Card has expired.";

      if (!/^\d{3,4}$/.test(document.getElementById("cvc").value)) return "Enter a valid CVC.";
      if (!document.getElementById("agree").checked) return "Please agree to terms & refund policy.";
      if (state.subtotal <= 0) return "Invalid order amount.";
      return null;
    }

    async function placeOrder(e){
      e.preventDefault();
      setStatus(null);
      const err = validateForm();
      if (err) { setStatus({type:'err',msg:err}); return; }

      setPlacing(true);
      const subtotal = state.subtotal;
      const taxes = round2(subtotal * state.taxRate);
      const shippingCost = currentShippingCost();
      const total = round2(subtotal + taxes + shippingCost);

      // Generate Order ID
      const orderId = 'ORD' + Date.now() + Math.floor(Math.random() * 1000);

      // Transform data to match beeceptor API format
      const authorizationData = {
        "OrderId": orderId,
        "CardDetails": {
          "CardNumber": state.card.number.replace(/\D/g, ''), // Remove non-digits
          "CardMonth": document.getElementById("exp").value.split('/')[0], // Extract month
          "CardYear": "20" + document.getElementById("exp").value.split('/')[1], // Extract year with century
          "CCV": document.getElementById("cvc").value
        },
        "RequestedAmount": total
      };

      const loading = document.getElementById('loading');
      const result = document.getElementById('result');
      const submitBtn = placeBtn;

      try {
        loading.style.display = 'block';
        result.style.display = 'none';
        submitBtn.disabled = true;
        submitBtn.textContent = 'Processing…';

        // Debug: Log what we're sending
        console.log('Sending to API:', authorizationData);

        // Call beeceptor authorization API
        const response = await fetch('https://capstoneproject.free.beeceptor.com/authorize', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(authorizationData),
        });

        // Debug: Log response details
        console.log('Response status:', response.status);
        console.log('Response ok:', response.ok);

        let data = null;
        
        // Handle 500 errors (which may not have valid JSON)
        if (response.status >= 500) {
          console.log('Server error detected');
          data = { error: 'Server temporarily unavailable', status: 'ERROR' };
        } else {
          try {
            data = await response.json();
          } catch (jsonError) {
            console.log('JSON parse error:', jsonError);
            data = { error: 'Invalid response format', status: 'ERROR' };
          }
        }
        
        console.log('Response data:', data);
        console.log('Data keys:', Object.keys(data || {}));
        console.log('Data.status:', data?.status);
        console.log('Data.success:', data?.success);
        console.log('Full response:', JSON.stringify(data, null, 2));
        
        // Display result
        loading.style.display = 'none';
        result.style.display = 'block';
        
        // Check for success in multiple possible formats
        const isSuccess = response.ok && (
          data.Success === true ||  // Beeceptor format (capital S)
          data.status === 'SUCCESS' || 
          data.status === 'success' ||
          data.success === true ||
          data.result === 'success' ||
          data.approved === true ||
          (response.status === 200 && !data.error && !data.failure && data.Reason === "")
        );
        
        console.log('Success check result:', isSuccess);
        
        if (isSuccess) {
            // Save to database (silent background operation)
            saveOrderToDatabase({
                // Customer data
                firstName: document.getElementById("firstName").value.trim(),
                lastName: document.getElementById("lastName").value.trim(),
                address: document.getElementById("address1").value.trim(),
                city: document.getElementById("city").value.trim(),
                state: document.getElementById("state").value,
                zip: document.getElementById("zip").value.trim(),
                email: document.getElementById("email").value.trim(),
                // Order data
                orderId: data.OrderId || orderId,
                subtotal: subtotal,
                tax: taxes,
                total: total,
                // Authorization data
                authorizationToken: data.AuthorizationToken,
                authorizedAmount: data.AuthorizedAmount || total,
                authorizationDate: new Date().toISOString(),
                // Payment/Card data
                cardType: guessBrand(state.card.number) === "AmEx" ? "American Express" : guessBrand(state.card.number),
                maskedCard: state.card.number.slice(-4),
                expirationMonth: parseInt(document.getElementById("exp").value.split('/')[0]),
                expirationYear: parseInt("20" + document.getElementById("exp").value.split('/')[1])
            });
            
            result.className = 'result success';
            result.innerHTML = `
                <h3>Payment Successful!</h3>
                <p><strong>Order Confirmation:</strong> ${data.OrderId || orderId}</p>
                <p><strong>Amount Charged:</strong> $${Number(data.AuthorizedAmount || total).toFixed(2)}</p>
                <p>Thank you for your purchase!</p>
            `;
            // Generate new random order for next use
            state.subtotal = generateRandomOrderAmount();
            renderTotals();
            document.getElementById('checkoutForm').reset();
            state.card.number = '';
            updateCardPreview();
        } else {
            // Handle different failure scenarios
            let errorMessage = 'Payment authorization failed';
            
            if (response.status >= 500 || (data.status === 'ERROR' && data.error && data.error.includes('Server'))) {
                errorMessage = 'Payment service temporarily unavailable. Please try again later.';
            } else if (data.Success === false && data.Reason) {
                // Beeceptor failure format
                if (data.Reason.toLowerCase().includes('insufficient')) {
                    errorMessage = 'Payment failed: Insufficient funds. Please try a different card.';
                } else if (data.Reason.toLowerCase().includes('incorrect') || data.Reason.toLowerCase().includes('invalid')) {
                    errorMessage = 'Payment failed: Incorrect card details. Please verify your information.';
                } else {
                    errorMessage = `Payment failed: ${data.Reason}`;
                }
            } else if (data.error && data.error.includes('Insufficient')) {
                errorMessage = 'Payment failed: Insufficient funds. Please try a different card.';
            } else if (data.error && data.error.includes('Incorrect')) {
                errorMessage = 'Payment failed: Incorrect card details. Please verify your information.';
            } else if (data.error) {
                errorMessage = `Payment failed: ${data.error}`;
            } else if (data.message) {
                errorMessage = `Payment failed: ${data.message}`;
            }
            
            result.className = 'result error';
            result.innerHTML = `
                <h3>Payment Failed</h3>
                <p>${errorMessage}</p>
                <p>Please try again or contact customer service if the problem persists.</p>
            `;
        }
        
      } catch (error) {
        loading.style.display = 'none';
        result.style.display = 'block';
        result.className = 'result error';
        result.innerHTML = `
            <h3>Payment Failed</h3>
            <p>We're having trouble processing your payment right now.</p>
            <p>Please check your internet connection and try again.</p>
        `;
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Pay ' + fmt(total);
        setPlacing(false);
      }
    }

    function setPlacing(val){
      state.placing = val;
      placeBtn.disabled = !!val;
      placeBtn.textContent = val ? "Placing order…" : "Pay " + document.getElementById("total").textContent;
    }

    function setStatus(s){
      state.status = s;
      if (!s){ statusEl.style.display="none"; statusEl.textContent=""; statusEl.className="status"; return; }
      statusEl.style.display = "block";
      statusEl.className = "status " + (s.type === "ok" ? "success" : "error");
      statusEl.textContent = s.msg;
    }

    // initialize totals on load
    renderTotals();
    updateCardPreview();
  </script>
</body>
</html>
