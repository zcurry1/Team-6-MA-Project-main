<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Warehouse Order Management</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-align: center;
            padding: 2rem;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card h3 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #333;
        }

        .controls {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .controls h3 {
            margin-bottom: 15px;
            color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #51cf66 0%, #40c057 100%);
        }

        .search-bar {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 16px;
            margin-bottom: 15px;
        }

        .search-bar:focus {
            outline: none;
            border-color: #667eea;
        }

        .orders-section {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .section-header {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
        }

        .orders-table {
            width: 100%;
            border-collapse: collapse;
        }

        .orders-table th,
        .orders-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        .orders-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        .orders-table tr:hover {
            background: #f8f9fa;
        }

        .status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-completed {
            background: #d4edda;
            color: #155724;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-failed {
            background: #f8d7da;
            color: #721c24;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }

        .no-orders {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .pagination {
            padding: 20px;
            text-align: center;
        }

        .pagination button {
            margin: 0 5px;
        }

        .order-actions {
            display: flex;
            gap: 5px;
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 12px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .orders-table {
                font-size: 14px;
            }
            
            .orders-table th,
            .orders-table td {
                padding: 8px 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üè™ Warehouse Order Management</h1>
            <p>Traditional HTML/CSS/JS Implementation</p>
        </header>

        <!-- Dashboard Statistics -->
        <div class="dashboard" id="dashboard">
            <div class="stat-card">
                <h3>Total Orders</h3>
                <div class="stat-number" id="totalOrders">-</div>
            </div>
            <div class="stat-card">
                <h3>Completed Orders</h3>
                <div class="stat-number" id="completedOrders">-</div>
            </div>
            <div class="stat-card">
                <h3>Pending Orders</h3>
                <div class="stat-number" id="pendingOrders">-</div>
            </div>
            <div class="stat-card">
                <h3>Total Revenue</h3>
                <div class="stat-number" id="totalRevenue">$-</div>
            </div>
        </div>

        <!-- Controls -->
        <div class="controls">
            <h3>Order Management</h3>
            <input type="text" class="search-bar" id="searchBar" placeholder="Search orders by email, name, or order ID...">
            
            <button class="btn" onclick="loadOrders()">üîÑ Refresh Orders</button>
            <button class="btn btn-success" onclick="exportOrders()">üìä Export CSV</button>
            <button class="btn" onclick="loadAnalytics()">üìà Reload Analytics</button>
        </div>

        <!-- Orders Section -->
        <div class="orders-section">
            <div class="section-header">
                <h3>Order History</h3>
            </div>
            
            <div id="loading" class="loading" style="display: none;">
                <div class="spinner"></div>
                <p>Loading orders...</p>
            </div>

            <div id="error" class="error" style="display: none;"></div>

            <div id="ordersContainer">
                <table class="orders-table" id="ordersTable" style="display: none;">
                    <thead>
                        <tr>
                            <th>Order ID</th>
                            <th>Customer</th>
                            <th>Email</th>
                            <th>Amount</th>
                            <th>Status</th>
                            <th>Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="ordersTableBody">
                    </tbody>
                </table>

                <div class="no-orders" id="noOrders" style="display: none;">
                    <h3>No Orders Found</h3>
                    <p>There are no orders in the system yet.</p>
                </div>
            </div>

            <div class="pagination" id="pagination" style="display: none;">
                <button class="btn" onclick="previousPage()">‚Üê Previous</button>
                <span id="pageInfo">Page 1</span>
                <button class="btn" onclick="nextPage()">Next ‚Üí</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let allOrders = [];
        let filteredOrders = [];
        let currentPage = 1;
        const ordersPerPage = 10;

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Warehouse Management System Initialized');
            loadOrders();
            loadAnalytics();
            setupSearchBar();
        });

        // Setup search functionality
        function setupSearchBar() {
            const searchBar = document.getElementById('searchBar');
            searchBar.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                filterOrders(searchTerm);
            });
        }

        // Load all orders from the backend
        async function loadOrders() {
            const loadingEl = document.getElementById('loading');
            const errorEl = document.getElementById('error');
            const ordersTable = document.getElementById('ordersTable');
            const noOrders = document.getElementById('noOrders');

            try {
                loadingEl.style.display = 'block';
                errorEl.style.display = 'none';
                ordersTable.style.display = 'none';
                noOrders.style.display = 'none';

                console.log('Fetching orders from backend...');
                const response = await fetch('http://localhost:3001/api/warehouse/orders');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('Orders loaded:', data);

                // Handle the correct data structure from your API
                allOrders = data.orders || [];
                
                // Map the API fields to match our expected structure
                allOrders = allOrders.map(order => ({
                    id: order.order_id,
                    first_name: order.customer_first_name,
                    last_name: order.customer_last_name,
                    customer_email: order.customer_email,
                    total_amount: order.total_amount,
                    payment_status: order.payment_status || order.order_status,
                    created_at: order.created_at
                }));
                
                filteredOrders = [...allOrders];
                
                displayOrders();
                
            } catch (error) {
                console.error('Error loading orders:', error);
                errorEl.textContent = `Error loading orders: ${error.message}. Make sure the backend server is running on localhost:3001`;
                errorEl.style.display = 'block';
            } finally {
                loadingEl.style.display = 'none';
            }
        }

        // Load analytics/statistics
        async function loadAnalytics() {
            try {
                console.log('Fetching analytics from backend...');
                const response = await fetch('http://localhost:3001/api/warehouse/analytics');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('Analytics loaded:', data);

                // Handle the correct data structure from your API
                const analytics = data.analytics || {};
                
                // Calculate totals from the analytics data
                let totalOrders = 0;
                let totalRevenue = 0;
                let completedOrders = 0;
                let pendingOrders = 0;

                // Sum up from orderStats
                if (analytics.orderStats) {
                    analytics.orderStats.forEach(stat => {
                        totalOrders += parseInt(stat.count);
                        totalRevenue += parseFloat(stat.total_value);
                        
                        if (stat.order_status === 'shipped' || stat.order_status === 'captured') {
                            completedOrders += parseInt(stat.count);
                        } else {
                            pendingOrders += parseInt(stat.count);
                        }
                    });
                }

                // Update dashboard statistics
                document.getElementById('totalOrders').textContent = totalOrders;
                document.getElementById('completedOrders').textContent = completedOrders;
                document.getElementById('pendingOrders').textContent = pendingOrders;
                document.getElementById('totalRevenue').textContent = `$${totalRevenue.toFixed(2)}`;
                
            } catch (error) {
                console.error('Error loading analytics:', error);
                // Don't show error for analytics, just log it
                // Set default values
                document.getElementById('totalOrders').textContent = '0';
                document.getElementById('completedOrders').textContent = '0';
                document.getElementById('pendingOrders').textContent = '0';
                document.getElementById('totalRevenue').textContent = '$0.00';
            }
        }

        // Filter orders based on search term
        function filterOrders(searchTerm) {
            if (!searchTerm) {
                filteredOrders = [...allOrders];
            } else {
                filteredOrders = allOrders.filter(order => 
                    order.customer_email.toLowerCase().includes(searchTerm) ||
                    `${order.first_name} ${order.last_name}`.toLowerCase().includes(searchTerm) ||
                    order.id.toString().includes(searchTerm)
                );
            }
            currentPage = 1;
            displayOrders();
        }

        // Display orders in the table
        function displayOrders() {
            const ordersTable = document.getElementById('ordersTable');
            const noOrders = document.getElementById('noOrders');
            const ordersTableBody = document.getElementById('ordersTableBody');

            if (filteredOrders.length === 0) {
                ordersTable.style.display = 'none';
                noOrders.style.display = 'block';
                updatePagination();
                return;
            }

            // Calculate pagination
            const startIndex = (currentPage - 1) * ordersPerPage;
            const endIndex = startIndex + ordersPerPage;
            const ordersToShow = filteredOrders.slice(startIndex, endIndex);

            // Clear existing table content
            ordersTableBody.innerHTML = '';

            // Populate table with orders
            ordersToShow.forEach(order => {
                const row = document.createElement('tr');
                
                // Determine status
                const status = order.payment_status || 'pending';
                const statusClass = status === 'completed' ? 'status-completed' : 
                                  status === 'failed' ? 'status-failed' : 'status-pending';

                // Format date
                const orderDate = new Date(order.created_at).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                row.innerHTML = `
                    <td>#${order.id}</td>
                    <td>${order.first_name} ${order.last_name}</td>
                    <td>${order.customer_email}</td>
                    <td>$${parseFloat(order.total_amount).toFixed(2)}</td>
                    <td><span class="status ${statusClass}">${status.charAt(0).toUpperCase() + status.slice(1)}</span></td>
                    <td>${orderDate}</td>
                    <td>
                        <div class="order-actions">
                            <button class="btn btn-small" onclick="viewOrderDetails(${order.id})">üëÅÔ∏è View</button>
                            <button class="btn btn-small btn-success" onclick="markCompleted(${order.id})">‚úÖ Complete</button>
                        </div>
                    </td>
                `;

                ordersTableBody.appendChild(row);
            });

            ordersTable.style.display = 'table';
            noOrders.style.display = 'none';
            updatePagination();
        }

        // Update pagination controls
        function updatePagination() {
            const pagination = document.getElementById('pagination');
            const pageInfo = document.getElementById('pageInfo');
            
            const totalPages = Math.ceil(filteredOrders.length / ordersPerPage);
            
            if (totalPages <= 1) {
                pagination.style.display = 'none';
                return;
            }

            pagination.style.display = 'block';
            pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
            
            // Update button states
            const prevBtn = pagination.querySelector('button:first-child');
            const nextBtn = pagination.querySelector('button:last-child');
            
            prevBtn.disabled = currentPage === 1;
            nextBtn.disabled = currentPage === totalPages;
        }

        // Pagination functions
        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                displayOrders();
            }
        }

        function nextPage() {
            const totalPages = Math.ceil(filteredOrders.length / ordersPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                displayOrders();
            }
        }

        // Order action functions
        function viewOrderDetails(orderId) {
            const order = allOrders.find(o => o.id === orderId);
            if (order) {
                alert(`Order Details:\n\nOrder ID: #${order.id}\nCustomer: ${order.first_name} ${order.last_name}\nEmail: ${order.customer_email}\nAmount: $${parseFloat(order.total_amount).toFixed(2)}\nStatus: ${order.payment_status || 'pending'}\nDate: ${new Date(order.created_at).toLocaleString()}`);
            }
        }

        async function markCompleted(orderId) {
            try {
                // This would typically make a PUT/PATCH request to update order status
                // For now, we'll just show a confirmation and reload
                const confirmed = confirm(`Mark order #${orderId} as completed?`);
                if (confirmed) {
                    // In a real app, you'd make an API call here:
                    // await fetch(`http://localhost:3001/api/warehouse/orders/${orderId}`, {
                    //     method: 'PATCH',
                    //     headers: { 'Content-Type': 'application/json' },
                    //     body: JSON.stringify({ status: 'completed' })
                    // });
                    
                    alert(`Order #${orderId} marked as completed!`);
                    loadOrders(); // Reload orders
                    loadAnalytics(); // Reload analytics
                }
            } catch (error) {
                console.error('Error updating order:', error);
                alert('Error updating order status');
            }
        }

        // Export functionality
        function exportOrders() {
            if (filteredOrders.length === 0) {
                alert('No orders to export');
                return;
            }

            // Create CSV content
            const headers = ['Order ID', 'First Name', 'Last Name', 'Email', 'Amount', 'Status', 'Date'];
            const csvContent = [
                headers.join(','),
                ...filteredOrders.map(order => [
                    order.id,
                    `"${order.first_name}"`,
                    `"${order.last_name}"`,
                    `"${order.customer_email}"`,
                    order.total_amount,
                    order.payment_status || 'pending',
                    `"${new Date(order.created_at).toISOString()}"`
                ].join(','))
            ].join('\n');

            // Download CSV
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `orders-export-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            alert(`Exported ${filteredOrders.length} orders to CSV`);
        }

        // Error handling for network issues
        window.addEventListener('online', function() {
            console.log('Connection restored, reloading data...');
            loadOrders();
            loadAnalytics();
        });

        window.addEventListener('offline', function() {
            console.log('Connection lost');
            const errorEl = document.getElementById('error');
            errorEl.textContent = 'Connection lost. Please check your internet connection.';
            errorEl.style.display = 'block';
        });
    </script>
</body>
</html>